<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Eye-Q Health Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #1e3c72, #2a5298);
      color: #212529;
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .dark-mode {
      background: #121212 !important;
      color: #f1f1f1;
    }

    .report-box {
      background: #fff;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      width: 100%;
      max-width: 800px;
      opacity: 0;
      transform: translateY(50px);
      transition: background 0.3s, color 0.3s;
    }

    .dark-mode .report-box {
      background: #1f1f2f;
      color: #fff;
      box-shadow: 0 0 10px #444;
    }

    .title {
      text-align: center;
      margin-bottom: 1.5rem;
      font-weight: 600;
      color: #0d6efd;
    }

    .dark-mode .title {
      color: #4dabf7;
    }

    .metric {
      font-size: 1.1rem;
      padding: 10px 0;
      border-radius: 8px;
      background: rgba(13, 110, 253, 0.05);
      margin-bottom: 10px;
    }

    .alert-box h5 {
      margin-bottom: 10px;
      font-weight: 600;
    }

    .btn-export {
      margin-top: 2rem;
    }

    .toggle-dark {
      position: fixed;
      top: 20px;
      right: 20px;
    }
  </style>
</head>
<body>

<!-- Dark Mode Toggle -->
<div class="toggle-dark">
  <button class="btn btn-sm btn-outline-light" onclick="toggleDarkMode()">Toggle Theme</button>
</div>

<div class="report-box" id="report-content">
  <h2 class="title">Eye-Q Health Report</h2>

  <p class="text-muted text-center mb-4">Patient: {{ session.get('email') }} | Phone: {{ session.get('phone') }}</p>

  <div class="row text-center mb-4">
    <div class="col-md-4">
      <div class="metric text-info"><strong>IOP:</strong> {{ data.iop if data else 'N/A' }} mmHg</div>
    </div>
    <div class="col-md-4">
      <div class="metric text-success"><strong>Blue Light:</strong> {{ data.blue_light if data else 'N/A' }} units</div>
    </div>
    <div class="col-md-4">
      <div class="metric text-warning"><strong>Screen Time:</strong> {{ data.screen_time if data else 'N/A' }} hrs</div>
    </div>
  </div>

  {% if alerts %}
  <div class="alert-box">
    <h5>Alerts</h5>
    {% for alert in alerts %}
    <div class="alert alert-warning" role="alert">
      {{ alert }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <hr>
  <h5 class="mb-3">IOP Trend</h5>
  <canvas id="trendChart" height="100"></canvas>

  <div class="text-center">
    <button class="btn btn-dark btn-export" onclick="downloadPDF()">Export as PDF</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  // Animate report box
  gsap.to("#report-content", {
    duration: 1,
    opacity: 1,
    y: 0,
    ease: "power3.out"
  });

  // Chart.js
  const chart = new Chart(document.getElementById("trendChart"), {
    type: 'line',
    data: {
      labels: {{ iop.timestamps|tojson }},
      datasets: [{
        label: 'IOP (mmHg)',
        data: {{ iop.values|tojson }},
        borderColor: 'rgba(33, 150, 243, 1)',
        backgroundColor: 'rgba(33, 150, 243, 0.2)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });

  // Download PDF
  function downloadPDF() {
    const report = document.getElementById("report-content");
    html2pdf().from(report).save("EyeQ_Health_Report.pdf");
  }

  // Dark Mode
  function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem('theme', document.body.classList.contains("dark-mode") ? 'dark' : 'light');
  }

  // Load saved theme
  window.onload = () => {
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add("dark-mode");
    }
  };
</script>

</body>
</html>
