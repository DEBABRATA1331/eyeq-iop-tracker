<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Eye-Q Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    .dark-mode { background-color: #121212 !important; color: #fff !important; }
    .dark-mode .card { background-color: #1e1e1e !important; color: #fff !important; }
    .card {
      border-radius: 16px;
      transition: 0.3s ease-in-out;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .metric-value {
      font-size: 2.3rem;
      font-weight: bold;
    }
    .theme-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 999;
    }
  </style>
</head>
<body class="bg-light">

<!-- Dark Mode Toggle -->
<div class="theme-toggle">
  <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary">üåì Theme</button>
</div>

<div class="container py-4" id="dashboard-content">
  <h2 class="text-center mb-4">üëÅÔ∏è Eye-Q Health Dashboard</h2>

  <!-- Metrics -->
  <div class="row g-4">
    <div class="col-md-4">
      <div class="card text-center p-3">
        <div class="card-body">
          <h5 class="card-title">IOP</h5>
          <p id="iop-value" class="metric-value text-info">{{ data.iop if data else 'N/A' }}</p>
          <small>mmHg</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center p-3">
        <div class="card-body">
          <h5 class="card-title">Blue Light</h5>
          <p id="blue-value" class="metric-value text-success">{{ data.blue_light if data else 'N/A' }}</p>
          <small>units</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center p-3">
        <div class="card-body">
          <h5 class="card-title">Screen Time</h5>
          <p id="screen-value" class="metric-value text-warning">{{ data.screen_time if data else 'N/A' }}</p>
          <small>hours</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts -->
  {% if alerts %}
  <div class="mt-4">
    <h5>üö® Alerts</h5>
    {% for alert in alerts %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      {{ alert }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Chart Controls -->
  <div class="text-center mt-4">
    <button class="btn btn-outline-primary mx-1" onclick="showChart('iop')">IOP</button>
    <button class="btn btn-outline-success mx-1" onclick="showChart('blue')">Blue Light</button>
    <button class="btn btn-outline-warning mx-1" onclick="showChart('screen')">Screen Time</button>
  </div>

  <!-- Chart -->
  <div class="card mt-4 p-4">
    <h5 id="chart-title">üìà IOP Trend</h5>
    <canvas id="trendChart" height="100"></canvas>
  </div>

  <!-- Navigation + PDF Export -->
  <div class="text-center mt-5">
    <a href="{{ url_for('history') }}" class="btn btn-outline-primary mx-1">üìú History</a>
    <a href="{{ url_for('report') }}" class="btn btn-outline-secondary mx-1">üìÑ Report</a>
    <a href="{{ url_for('hospitals') }}" class="btn btn-outline-success mx-1">üè• Hospitals</a>
    <button onclick="downloadPDF()" class="btn btn-outline-dark mx-1">üì§ Download PDF</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  // Chart Setup
  let chart;
  const ctx = document.getElementById('trendChart').getContext('2d');

  const chartData = {
    iop: {
      label: 'IOP (mmHg)',
      data: {{ iop["values"]|default([], true)|tojson }},
      labels: {{ iop["timestamps"]|default([], true)|tojson }},
      color: 'rgba(33, 150, 243, 1)'
    },
    blue: {
      label: 'Blue Light',
      data: {{ blue_light["values"]|default([], true)|tojson }},
      labels: {{ blue_light["timestamps"]|default([], true)|tojson }},
      color: 'rgba(76, 175, 80, 1)'
    },
    screen: {
      label: 'Screen Time (hrs)',
      data: {{ screen_time["values"]|default([], true)|tojson }},
      labels: {{ screen_time["timestamps"]|default([], true)|tojson }},
      color: 'rgba(255, 152, 0, 1)'
    }
  };

  function showChart(type) {
    document.getElementById('chart-title').innerText = `üìà ${chartData[type].label} Trend`;
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData[type].labels,
        datasets: [{
          label: chartData[type].label,
          data: chartData[type].data,
          borderColor: chartData[type].color,
          backgroundColor: chartData[type].color.replace('1)', '0.2)'),
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  }

  // Auto-Refresh
  setInterval(() => {
    fetch("/api/latest_data")
      .then(res => res.json())
      .then(data => {
        document.getElementById("iop-value").innerText = data.iop ?? 'N/A';
        document.getElementById("blue-value").innerText = data.blue_light ?? 'N/A';
        document.getElementById("screen-value").innerText = data.screen_time ?? 'N/A';
      });
  }, 5000);

  // Dark Mode Toggle
  const root = document.body;
  function toggleTheme() {
    root.classList.toggle('dark-mode');
    localStorage.setItem('theme', root.classList.contains('dark-mode') ? 'dark' : 'light');
  }
  if (localStorage.getItem('theme') === 'dark') root.classList.add('dark-mode');

  // PDF Export
  function downloadPDF() {
    html2pdf().from(document.getElementById("dashboard-content")).save("EyeQ_Report.pdf");
  }

  // Init Chart
  showChart('iop');
</script>
</body>
</html>
