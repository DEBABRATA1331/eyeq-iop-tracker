<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Eye-Q Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Animations (GSAP) -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      min-height: 100vh;
    }
    .dark-mode {
      background: #121212 !important;
      color: #f1f1f1 !important;
    }
    .dark-mode .card,
    .dark-mode .chart-card,
    .dark-mode .nav-card,
    .dark-mode .suggestion-card {
      background-color: #1e1e1e !important;
      color: #fff !important;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 2rem;
      font-weight: 600;
      font-size: 2rem;
      color: #2a5298;
      white-space: nowrap;
      overflow: hidden;
      border-right: 3px solid #2a5298;
      width: 0;
    }
    .card {
      border-radius: 16px;
      padding: 1rem;
      border: none;
      background: white;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      height: 100%;
    }
    .metric-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin-top: 0.5rem;
    }
    .theme-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 999;
    }
    .chart-card, .suggestion-card {
      display: none;
      padding: 1.5rem;
      border-radius: 16px;
      background: white;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    .btn-custom {
      border-radius: 30px;
      padding: 0.5rem 1.2rem;
    }
    .loading-bar {
      height: 5px;
      width: 0;
      background: linear-gradient(90deg, #2a5298, #1e90ff);
      border-radius: 3px;
      margin: 10px 0;
    }
    .nav-card {
      margin-top: 2rem;
      padding: 1.5rem;
      border-radius: 16px;
      background: white;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      opacity: 0;
      transform: translateY(30px);
    }
  </style>
</head>
<body>

<!-- Theme Toggle -->
<div class="theme-toggle">
  <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary">Toggle Theme</button>
</div>

<div class="container py-4" id="dashboard-content">
  <h2 class="dashboard-header" id="typewriter">Eye-Q Health Dashboard</h2>

  <!-- Metrics -->
  <div class="row g-4">
    <div class="col-md-3">
      <div class="card text-center">
        <h5>IOP</h5>
        <div id="iop-value" class="metric-value text-info">{{ data.iop if data else 'N/A' }}</div>
        <small>mmHg</small>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <h5>Blue Light</h5>
        <div id="blue-value" class="metric-value text-success">{{ data.blue_light if data else 'N/A' }}</div>
        <small>hours</small>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <h5>Screen Time</h5>
        <div id="screen-value" class="metric-value text-warning">{{ data.screen_time if data else 'N/A' }}</div>
        <small>Seconds</small>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <h5>Blink Rate</h5>
        <div id="blink-value" class="metric-value text-primary">{{ data.blink_rate if data else 'N/A' }}</div>
        <small>blinks/min</small>
      </div>
    </div>
  </div>

  <!-- Loading Bar -->
  <div class="loading-bar" id="loadingBar"></div>

  <!-- Chart Controls -->
  <div class="text-center mt-4">
    <button class="btn btn-outline-primary btn-custom" onclick="showChart('iop')">IOP</button>
    <button class="btn btn-outline-success btn-custom" onclick="showChart('blue')">Blue Light</button>
    <button class="btn btn-outline-warning btn-custom" onclick="showChart('screen')">Screen Time</button>
    <button class="btn btn-outline-info btn-custom" onclick="showChart('blink')">Blink Rate</button>
  </div>

  <!-- Chart -->
  <div class="chart-card mt-4" id="chartCard">
    <h5 id="chart-title">Trend</h5>
    <canvas id="trendChart" height="100"></canvas>
  </div>

  <!-- AI Suggestions -->
  <div class="suggestion-card mt-4" id="suggestionCard">
    <h5>AI Health Suggestions</h5>
    <ul id="suggestionList" class="list-group list-group-flush"></ul>
  </div>

  <!-- Navigation (Animated Card) -->
  <div class="nav-card text-center" id="navCard">
    <a href="{{ url_for('history') }}" class="btn btn-outline-primary btn-custom">History</a>
    <a href="{{ url_for('report') }}" class="btn btn-outline-secondary btn-custom">Report</a>
    <a href="{{ url_for('hospitals') }}" class="btn btn-outline-success btn-custom">Hospitals</a>
    <button onclick="downloadPDF()" class="btn btn-outline-dark btn-custom">Download PDF</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  let chart;
  const ctx = document.getElementById('trendChart').getContext('2d');

  const chartData = {
    iop: { label: 'IOP (mmHg)', data: {{ iop["values"]|default([], true)|tojson }}, labels: {{ iop["timestamps"]|default([], true)|tojson }}, color: 'rgba(33, 150, 243, 1)' },
    blue: { label: 'Blue Light (hrs)', data: {{ blue_light["values"]|default([], true)|tojson }}, labels: {{ blue_light["timestamps"]|default([], true)|tojson }}, color: 'rgba(76, 175, 80, 1)' },
    screen: { label: 'Screen Time (hrs)', data: {{ screen_time["values"]|default([], true)|tojson }}, labels: {{ screen_time["timestamps"]|default([], true)|tojson }}, color: 'rgba(255, 152, 0, 1)' },
    blink: { label: 'Blink Rate (blinks/min)', data: {{ blink_rate["values"]|default([], true)|tojson }}, labels: {{ blink_rate["timestamps"]|default([], true)|tojson }}, color: 'rgba(0, 188, 212, 1)' }
  };

  function showChart(type) {
    document.getElementById("chartCard").style.display = "block";
    document.getElementById("suggestionCard").style.display = "block";

    document.getElementById('chart-title').innerText = `${chartData[type].label} Trend`;
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: chartData[type].labels, datasets: [{ label: chartData[type].label, data: chartData[type].data, borderColor: chartData[type].color, backgroundColor: chartData[type].color.replace('1)', '0.15)'), fill: true, tension: 0.4 }] },
      options: { responsive: true }
    });

    generateSuggestions();
  }

  function generateSuggestions() {
    const iop = parseFloat(document.getElementById("iop-value").innerText) || null;
    const blue = parseFloat(document.getElementById("blue-value").innerText) || null;
    const screen = parseFloat(document.getElementById("screen-value").innerText) || null;
    const blink = parseFloat(document.getElementById("blink-value").innerText) || null;

    const suggestions = [];

    // IOP
    if (iop) {
      if (iop < 10) suggestions.push("âš ï¸ IOP too low â€“ consult an ophthalmologist.");
      else if (iop <= 21) suggestions.push("âœ… IOP is normal.");
      else if (iop <= 24) suggestions.push("âš ï¸ Slightly high IOP â€“ schedule checkup soon.");
      else suggestions.push("ðŸš¨ High IOP â€“ risk of glaucoma, consult doctor immediately.");
    }

    // Blue Light
    if (blue) {
      if (blue < 2) suggestions.push("âœ… Blue light exposure is safe.");
      else if (blue <= 5) suggestions.push("âš ï¸ Moderate blue light exposure â€“ reduce screen use or wear filter glasses.");
      else suggestions.push("ðŸš¨ Excessive blue light â€“ use protective glasses and reduce usage.");
    }

    // Screen Time
    if (screen) {
      if (screen < 4) suggestions.push("âœ… Screen usage is within healthy range.");
      else if (screen <= 8) suggestions.push("âš ï¸ High screen time â€“ follow 20-20-20 rule (every 20 min, look 20 ft away for 20 sec).");
      else suggestions.push("ðŸš¨ Dangerous screen time â€“ reduce usage and take frequent breaks.");
    }

    // Blink Rate
    if (blink) {
      if (blink >= 15) suggestions.push("âœ… Blink rate is healthy.");
      else if (blink >= 10) suggestions.push("âš ï¸ Slightly low blink rate â€“ try blinking exercises (5 quick blinks every 30 mins).");
      else suggestions.push("ðŸš¨ Very low blink rate â€“ take immediate breaks and use eye lubrication.");
    }

    const list = document.getElementById("suggestionList");
    list.innerHTML = "";
    suggestions.forEach(s => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = s;
      list.appendChild(li);
    });
  }

  // Auto-refresh with loading bar
  setInterval(() => {
    const bar = document.getElementById("loadingBar");
    gsap.fromTo(bar, { width: "0%" }, { width: "100%", duration: 2, onComplete: () => bar.style.width = "0%" });

    fetch("/api/latest_data")
      .then(res => res.json())
      .then(data => {
        document.getElementById("iop-value").innerText = data.iop ?? 'N/A';
        document.getElementById("blue-value").innerText = data.blue_light ?? 'N/A';
        document.getElementById("screen-value").innerText = data.screen_time ?? 'N/A';
        document.getElementById("blink-value").innerText = data.blink_rate ?? 'N/A';
        generateSuggestions();
      });
  }, 5000);

  // Theme toggle
  function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  }
  if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

  // PDF export
  function downloadPDF() {
    html2pdf().from(document.getElementById("dashboard-content")).save("EyeQ_Report.pdf");
  }

  // GSAP Animations
  gsap.from(".card", { opacity: 0, y: 50, stagger: 0.1, duration: 0.6 });
  gsap.to(".dashboard-header", { width: "20ch", duration: 2, ease: "steps(20)" });
  gsap.to("#navCard", { opacity: 1, y: 0, delay: 2, duration: 1 });
</script>
</body>
</html>
