<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Eye-Q History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f4f6f9;
    }
    .table-container {
      background: #fff;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    h2 {
      color: #1976d2;
      text-align: center;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    .sparkline {
      height: 40px;
      width: 100px;
    }
  </style>
</head>
<body>

<div class="container py-5">
  <div class="table-container">
    <h2>üìú Health History</h2>

    <!-- Filter Form -->
    <form method="get" class="row g-3 mb-3">
      <div class="col-md-5">
        <input type="text" name="start" class="form-control" placeholder="Start Date" id="start-date" value="{{ start }}">
      </div>
      <div class="col-md-5">
        <input type="text" name="end" class="form-control" placeholder="End Date" id="end-date" value="{{ end }}">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">üîç Filter</button>
      </div>
    </form>

    <!-- Export Button -->
    <div class="text-end mb-2">
      <button onclick="exportCSV()" class="btn btn-outline-dark btn-sm">üì§ Export CSV</button>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>IOP (mmHg)</th>
            <th>Blue Light</th>
            <th>Screen Time</th>
            <th>Timestamp</th>
            <th>Mini Trend</th>
          </tr>
        </thead>
        <tbody>
          {% for row in logs %}
          <tr>
            <td>{{ loop.index }}</td>
            <td class="text-info">{{ row.iop }}</td>
            <td class="text-success">{{ row.blue_light }}</td>
            <td class="text-warning">{{ row.screen_time }}</td>
            <td>{{ row.timestamp.strftime('%d-%b %H:%M') }}</td>
            <td>
              <canvas class="sparkline" id="spark-{{ loop.index }}"></canvas>
              <script>
                const ctx{{ loop.index }} = document.getElementById('spark-{{ loop.index }}').getContext('2d');
                new Chart(ctx{{ loop.index }}, {
                  type: 'line',
                  data: {
                    labels: ['I', 'B', 'S'],
                    datasets: [{
                      data: [{{ row.iop }}, {{ row.blue_light }}, {{ row.screen_time }}],
                      borderColor: '#1976d2',
                      backgroundColor: 'rgba(25, 118, 210, 0.1)',
                      tension: 0.4
                    }]
                  },
                  options: {
                    responsive: false,
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: { legend: { display: false } }
                  }
                });
              </script>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6">No data found for this range.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  flatpickr("#start-date", { dateFormat: "Y-m-d" });
  flatpickr("#end-date", { dateFormat: "Y-m-d" });

  function exportCSV() {
    const rows = Array.from(document.querySelectorAll("table tr"));
    const csv = rows.map(row =>
      Array.from(row.children).map(cell => cell.innerText).join(",")
    ).join("\\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "EyeQ_History_Filtered.csv";
    a.click();
  }
</script>

</body>
</html>
